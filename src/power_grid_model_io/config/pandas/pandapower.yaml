# SPDX-FileCopyrightText: 2022 Contributors to the Power Grid Model project <dynamic.grid.calculation@alliander.com>
#
# SPDX-License-Identifier: MPL-2.0
---

grid:
  bus:
    node:
      id: index
      u_rated: {power_grid_model_io.filters.multiply: [vn_kv, 1000]}
  line:
    line:
      id: index
      from_node: from_bus
      from_status:
        power_grid_model_io.filters.all_true:
          - in_service
          #- power_grid_model_io.filters.value_or_default: #returns False = open, True = closed or simply true if there is no value
            #- switch!closed[element=index,bus=from_bus]
            #- switch!closed[element=index]
            #- true
      to_node: to_bus
      to_status:
        power_grid_model_io.filters.all_true:
          - in_service
          #- power_grid_model_io.filters.value_or_default:
            # - switch!closed[element=index,bus=to_bus]
            #- switch!closed[element=index]
            #- true
      r1:
        power_grid_model_io.filters.multiply:
          - r_ohm_per_km
          - length_km
      x1:
        power_grid_model_io.filters.multiply:
          - x_ohm_per_km
          - length_km
      c1:
        power_grid_model_io.filters.multiply:
          - c_nf_per_km
          - length_km
      tan1: 0.0
      i_n: {power_grid_model_io.filters.multiply: [max_i_ka, 1000]}
  load:
    sym_load:
      - id: [index, 0]
        type: 0 #const_power
        node: bus
        status: in_service
        p_specified:
          {power_grid_model_io.filters.multiply:
            [{power_grid_model_io.filters.subtract: [100.0, const_z_percent, const_i_percent]}, 0.01, p_mw, 1000000 ]}
        q_specified:
          {power_grid_model_io.filters.multiply:
            [{power_grid_model_io.filters.subtract: [100.0, const_z_percent, const_i_percent]}, 0.01, q_mvar, 1000000]}
        condition:
          power_grid_model_io.filters.is_greater_than:
            - {power_grid_model_io.filters.subtract: [100.0, const_z_percent, const_i_percent]}
            - 0.0
      - id: [index, 1]
        type: 1 #const_impedance
        node: bus
        status: in_service
        p_specified: {power_grid_model_io.filters.multiply: [const_z_percent, 0.01, p_mw, 1000000]}
        q_specified: {power_grid_model_io.filters.multiply: [const_z_percent, 0.01, q_mvar, 1000000]}
        condition:
          power_grid_model_io.filters.is_greater_than:
            - const_z_percent
            - 0.0
      - id: index
        type: 2 #const_current
        node: bus
        status: in_service
        p_specified: {power_grid_model_io.filters.multiply: [const_i_percent, 0.01, p_mw, 1000000]}
        q_specified: {power_grid_model_io.filters.multiply: [const_i_percent, 0.01, q_mvar, 1000000]}
        condition:
          power_grid_model_io.filters.is_greater_than:
            - const_i_percent
            - 0.0
  ext_grid:
    source:
      id: [index, 0]
      node: bus
      status: in_service
      u_ref: vm_pu
  shunt:
    shunt:
      id: index
      node: bus
      status: in_service
      g1:
        power_grid_model_io.filters.pandapower.positive_sequence_conductance:
          - {power_grid_model_io.filters.multiply: [p_mw, 1000000]}
          - bus!vn_kv[bus!index=shunt!bus]
      b1:
        power_grid_model_io.filters.pandapower.positive_sequence_conductance:
          - {power_grid_model_io.filters.multiply: [q_mvar, 1000000]}
          - bus!vn_kv[bus!index=shunt!bus]
  sgen:
    sym_gen:
      id: index
      type: 0 #const_power
      node: bus
      status: in_service
      p_specified: {power_grid_model_io.filters.multiply: [p_mw, 1000000]}
      q_specified: {power_grid_model_io.filters.multiply: [q_mvar, 1000000]}
  trafo:
    transformer:
      id: index
      from_node: hv_bus
      from_status: in_service
      to_node: lv_bus
      to_status: in_service
      u1: {power_grid_model_io.filters.multiply: [vn_hv_kv, 1000]}
      u2: {power_grid_model_io.filters.multiply: [vn_lv_kv, 1000]}
      sn: {power_grid_model_io.filters.multiply: [sn_mva, 1000000]}
      uk: {power_grid_model_io.filters.multiply: [vkr_percent, 0.01]}
      pk: {power_grid_model_io.filters.multiply: [vkr_percent, 0.01, sn_mva, 1000000]}
      i0: {power_grid_model_io.filters.multiply: [i0_percent, 0.01]}
      p0: {power_grid_model_io.filters.multiply: [pfe_kw, 1000]}
      winding_from:
        power_grid_model_io.filters.pandapower.get_transformer_winding_from:
          self.get_trafo_vector_group:
            - vector_group | std_type
      winding_to:
        power_grid_model_io.filters.pandapower.get_transformer_winding_to:
          self.get_trafo_vector_group:
            - vector_group | std_type
      clock:
        power_grid_model_io.filters.pandapower.get_transformer_clock:
          - shift_degree
      tap_pos: tap_pos
      tap_side: tap_side
      tap_min: tap_min
      tap_max: tap_max
      tap_nom: tap_neutral #default zero
      tap_size:
        power_grid_model_io.filters.pandapower.get_transformer_tap_size:
          - {power_grid_model_io.filters.multiply: [vn_hv_kv, 1000]}
          - {power_grid_model_io.filters.multiply: [vn_lv_kv, 1000]}
          - tap_step_percent
          - tap_side
  trafo3w:
    three_winding_transformer:
      id: index
      node_1: hv_bus
      node_2: mv_bus
      node_3: lv_bus
      status_1: in_service #not completely right
      status_2: in_service
      status_3: in_service
      u1: {power_grid_model_io.filters.multiply: [vn_hv_kv, 1000]}
      u2: {power_grid_model_io.filters.multiply: [vn_mv_kv, 1000]}
      u3: {power_grid_model_io.filters.multiply: [vn_lv_kv, 1000]}
      sn_1: {power_grid_model_io.filters.multiply: [sn_hv_mva, 1000000]}
      sn_2: {power_grid_model_io.filters.multiply: [sn_mv_mva, 1000000]}
      sn_3: {power_grid_model_io.filters.multiply: [sn_lv_mva, 1000000]}
      uk_12: {power_grid_model_io.filters.multiply: [vk_hv_percent, 0.01]}
      uk_13: {power_grid_model_io.filters.multiply: [vk_lv_percent, 0.01]}
      uk_23: {power_grid_model_io.filters.multiply: [vk_mv_percent, 0.01]}
      pk_12:
        power_grid_model_io.filters.pandapower.get_3wdgtransformer_pk:
          - vkr_hv_percent
          - {power_grid_model_io.filters.multiply: [sn_hv_mva, 1000000]}
          - {power_grid_model_io.filters.multiply: [sn_mv_mva, 1000000]}
      pk_13:
        power_grid_model_io.filters.pandapower.get_3wdgtransformer_pk:
          - vkr_lv_percent
          - {power_grid_model_io.filters.multiply: [sn_hv_mva, 1000000]}
          - {power_grid_model_io.filters.multiply: [sn_lv_mva, 1000000]}
      pk_23:
        power_grid_model_io.filters.pandapower.get_3wdgtransformer_pk:
          - vkr_mv_percent
          - {power_grid_model_io.filters.multiply: [sn_mv_mva, 1000000]}
          - {power_grid_model_io.filters.multiply: [sn_lv_mva, 1000000]}
      i0: {power_grid_model_io.filters.multiply: [i0_percent, 0.01]}
      p0: {power_grid_model_io.filters.multiply: [pfe_kw, 1000]}
      winding_1:
        power_grid_model_io.filters.pandapower.get_3wdgtransformer_winding_1:
          self.get_trafo3w_vector_group:
            - vector_group | std_type
      winding_2:
        power_grid_model_io.filters.pandapower.get_3wdgtransformer_winding_2:
          self.get_trafo3w_vector_group:
            - vector_group | std_type
      winding_3:
        power_grid_model_io.filters.pandapower.get_3wdgtransformer_winding_3:
          self.get_trafo3w_vector_group:
            - vector_group | std_type
      clock_12:
        power_grid_model_io.filters.degrees_to_clock:
          - shift_mv_degree
      clock_13:
        power_grid_model_io.filters.degrees_to_clock:
          - shift_lv_degree
      tap_pos: tap_pos
      tap_side: tap_side
      tap_min: tap_min
      tap_max: tap_max
      tap_nom: tap_neutral
      tap_size:
        power_grid_model_io.filters.pandapower.get_3wdgtransformer_tap_size:
          - {power_grid_model_io.filters.multiply: [vn_hv_kv, 1000]}
          - {power_grid_model_io.filters.multiply: [vn_mv_kv, 1000]}
          - {power_grid_model_io.filters.multiply: [vn_lv_kv, 1000]}
          - tap_step_percent
          - tap_side
  switch:
    link:
      id: index
      from_node: bus
      to_node: element
      from_status: closed
      to_status: closed
      condition:
        power_grid_model_io.filters.pandapower.is_bus_switch:
          - et
substitutions:
  trafo.tap_side:
    "hv": 0
    "lv": 1
  trafo3w.tap_side:
    "hv": 0
    "mv": 1
    "lv": 2
